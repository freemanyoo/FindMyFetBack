# '찾아줘요' 프로젝트 백엔드 API 가이드 (Post & Search)

**문서 버전: 1.1**
**작성일: 2025-08-26**

## 1. 개요

본 문서는 '찾아줘요' 프로젝트의 백엔드 기능 중 **게시글(Post)**과 **검색 옵션(Search)** 파트에 대한 클래스별 기능 및 API 사용법을 정리한 가이드입니다.

-   **현재 상태**: 게시글 관련 모든 CRUD API 및 동적 검색 기능 구현이 완료되었습니다.
-   **문서 목적**: 다른 파트 담당자(회원, 댓글 등)가 게시글 관련 기능을 연동하거나 사용할 때 필요한 모든 정보를 제공하는 것을 목표로 합니다.

---

## 2. 주요 개발 결정사항 (Q&A 요약)

개발 과정에서 논의된 주요 결정사항은 다음과 같습니다.

> **Q1. 지역 검색은 어떤 필드를 기준으로 하나요?**
>
> **A1.** 게시글 목록 조회(`GET /api/posts`) 시 `region` 파라미터는 **`Post` 엔티티의 `location` 필드와 정확히 일치(equals)하는 것을 기준**으로 검색합니다. `User`의 `address` 필드는 사용하지 않습니다.

> **Q2. `SearchService`의 `getRegionList()`와 `Post.location`은 무슨 관계인가요?**
>
> **A2.** 두 요소는 프론트엔드를 통해 연결됩니다.
>
> -   `SearchService.getRegionList()`: 프론트엔드 UI의 **'지역 선택 드롭다운 메뉴'에 표시될 선택지 목록을 제공**하는 역할입니다. (API: `GET /api/regions`)
> -   `Post.location`: 사용자가 드롭다운에서 선택한 지역 값이 **실제로 DB에 저장되고, 검색 조건으로 사용되는 필드**입니다. 이 방식을 통해 데이터의 일관성을 유지합니다.

> **Q3. 코드 개선 작업은 어떤 것들이 있었나요?**
>
> **A3.** 초기 구현 이후 다음과 같은 리팩토링을 진행했습니다.
>
> 1.  **썸네일 URL 추가**: 목록 조회 시(`PostListResponseDto`), 게시글의 첫 번째 이미지를 `thumbnailUrl`로 제공하도록 개선하여 UI 완성도를 높였습니다.
> 2.  **패키지 구조 개선**: `search` 관련 클래스들을 `post` 패키지에서 독립적인 `search` 패키지로 분리하여 프로젝트 구조의 명확성을 높였습니다.
> 3.  **불필요한 코드 제거**: 페이징이 없는 `findAllPosts()` 메소드를 제거하여 코드베이스를 간결하게 유지했습니다.

---

## 3. 클래스별 상세 설명

### Ⅰ. Presentation Layer (Controllers)

API의 엔드포인트를 정의하고 클라이언트의 요청을 받아 서비스 계층에 전달합니다.

#### 1. `PostController.java`

-   **패키지**: `com.busanit501.findmyfet.controller.post`
-   **기능 정의**: 게시글(Post)과 관련된 모든 HTTP API 요청을 처리하는 컨트롤러입니다.
-   **주요 메소드**:
    -   `getPostList(PageRequestDto)`
        -   **API**: `GET /api/posts`
        -   **설명**: 게시글 목록을 동적 검색 조건(type, category, region, keyword)과 함께 페이징하여 조회합니다.
        -   **호출하는 서비스**: `postService.findAllPosts(pageRequestDTO)`
    -   `getPost(Long postId)`
        -   **API**: `GET /api/posts/{postId}`
        -   **설명**: 특정 게시글의 상세 정보를 조회합니다.
        -   **호출하는 서비스**: `postService.findPostById(postId)`
    -   `createPost(PostCreateRequestDto, List<MultipartFile>)`
        -   **API**: `POST /api/posts`
        -   **설명**: 새로운 게시글을 이미지와 함께 등록합니다.
        -   **호출하는 서비스**: `postService.createPost(...)`
    -   `updatePost(Long postId, ...)`
        -   **API**: `PUT /api/posts/{postId}`
        -   **설명**: 기존 게시글의 정보를 수정하고 이미지를 추가/삭제합니다.
        -   **호출하는 서비스**: `postService.updatePost(...)`
    -   `deletePost(Long postId)`
        -   **API**: `DELETE /api/posts/{postId}`
        -   **설명**: 특정 게시글을 삭제합니다.
        -   **호출하는 서비스**: `postService.deletePost(...)`
    -   `completePost(Long postId)`
        -   **API**: `PUT /api/posts/{postId}/complete`
        -   **설명**: 게시글의 상태를 '찾기 완료'로 변경합니다.
        -   **호출하는 서비스**: `postService.completePost(...)`
    -   `getMyPosts()`
        -   **API**: `GET /api/posts/my`
        -   **설명**: 현재 로그인된 사용자가 작성한 모든 게시글 목록을 조회합니다.
        -   **호출하는 서비스**: `postService.findMyPosts(...)`
-   **[중요] 연동 필요**: 현재 모든 메소드에서 `tempUserId = 1L` 을 사용 중입니다. **Spring Security 연동 후 `@AuthenticationPrincipal`을 통해 실제 사용자 ID를 받아오도록 수정해야 합니다.**

#### 2. `SearchController.java`

-   **패키지**: `com.busanit501.findmyfet.controller.search`
-   **기능 정의**: 프론트엔드 UI의 검색 필터(드롭다운 메뉴)를 구성하는 데 필요한 옵션 목록을 제공하는 컨트롤러입니다.
-   **주요 메소드**:
    -   `getCategoryList()`
        -   **API**: `GET /api/categories`
        -   **설명**: 동물 카테고리(예: "개")와 하위 품종(예: "말티즈", "푸들") 목록을 반환합니다.
        -   **호출하는 서비스**: `searchService.getCategoryList()`
    -   `getRegionList()`
        -   **API**: `GET /api/regions`
        -   **설명**: 검색 가능한 지역 목록(예: "서울시", "부산시")을 반환합니다.
        -   **호출하는 서비스**: `searchService.getRegionList()`

### Ⅱ. Business Logic Layer (Services)

비즈니스 로직을 처리하고, 트랜잭션을 관리합니다.

#### 1. `PostServiceImpl.java`

-   **패키지**: `com.busanit501.findmyfet.service.post`
-   **기능 정의**: 게시글 관련 모든 핵심 비즈니스 로직을 수행합니다.
-   **주요 메소드**:
    -   `findAllPosts(PageRequestDto)`: `PostRepository.search()`를 호출하여 동적 검색 및 페이징을 수행하고, 결과를 `PageResponseDto`로 가공하여 반환합니다.
    -   `createPost(...)`: DTO를 `Post` 엔티티로 변환하고, `FileUploadService`를 이용해 이미지를 저장한 후, `PostRepository`를 통해 DB에 저장합니다.
    -   `updatePost(...)`: JPA의 **더티 체킹(Dirty Checking)**을 활용하여 게시글 정보를 업데이트합니다. `FileUploadService`를 통해 기존 이미지를 삭제하고 새 이미지를 추가합니다.
    -   `deletePost(...)`: 게시글 삭제 전, `FileUploadService`를 통해 연관된 모든 물리적 이미지 파일을 먼저 삭제합니다. 이후 `PostRepository.delete()`를 호출하면 `orphanRemoval=true` 옵션에 의해 DB의 이미지 데이터도 함께 삭제됩니다.
    -   `validatePostAuthorOrAdmin(Post, Long)`: **(중요)** 게시글 수정/삭제 등 민감한 작업 수행 전, 현재 로그인한 사용자가 게시글 작성자이거나 관리자(`Role.Admin`)인지 검증하는 핵심 보안 로직입니다.

#### 2. `SearchServiceImpl.java`

-   **패키지**: `com.busanit501.findmyfet.service.search`
-   **기능 정의**: 검색 필터 옵션 목록을 제공하는 비즈니스 로직을 수행합니다.
-   **주요 메소드**:
    -   `getCategoryList()`: 기획서 기반의 고정된 동물 카테고리/품종 목록을 생성하여 반환합니다.
    -   `getRegionList()`: 기획서 기반의 고정된 지역 목록을 생성하여 반환합니다.
    -   **[참고]** 현재는 하드코딩 방식이지만, 추후 DB 테이블에서 이 데이터를 조회하도록 쉽게 확장할 수 있습니다.

#### 3. `FileUploadServiceImpl.java`

-   **패키지**: `com.busanit501.findmyfet.service.post`
-   **기능 정의**: MultipartFile을 실제 물리적 파일로 서버에 저장하거나 삭제하는 역할을 전담합니다.
-   **주요 메소드**:
    -   `upload(MultipartFile)`: 파일 이름의 충돌을 방지하기 위해 UUID를 사용하여 고유한 파일명을 생성하고, `application.properties`에 설정된 경로(`file.upload-dir`)에 파일을 저장합니다.
    -   `delete(String)`: 주어진 파일명으로 서버에 저장된 파일을 찾아 삭제합니다.

### Ⅲ. Data Access Layer (Repositories)

데이터베이스와의 통신(CRUD)을 담당합니다.

#### 1. `PostRepositoryCustomImpl.java`

-   **패키지**: `com.busanit501.findmyfet.repository.post`
-   **기능 정의**: **QueryDSL**을 사용하여 복잡한 동적 검색 쿼리를 구현하는 클래스입니다.
-   **주요 메소드**:
    -   `search(PageRequestDto, Pageable)`
        -   **설명**: `PageRequestDto`의 검색 조건(`type`, `category`, `region`, `keyword`) 유무에 따라 `BooleanBuilder`를 이용해 동적으로 WHERE 절을 생성합니다.
        -   **성능 최적화**: `leftJoin(post.user).fetchJoin()`을 사용하여 게시글 조회 시 N+1 문제가 발생하지 않도록 합니다.
        -   **사용되는 곳**: `PostServiceImpl.findAllPosts`에서 호출됩니다.

#### 2. `UserRepository.java`

-   **패키지**: `com.busanit501.findmyfet.repository.user`
-   **기능 정의**: `User` 엔티티에 대한 기본적인 CRUD를 담당합니다.
-   **사용되는 곳**: `PostServiceImpl`에서 게시글 작성자의 정보를 조회하거나 권한을 검증할 때 사용됩니다.

### Ⅳ. Domain Layer (Entities)

데이터베이스 테이블과 1:1로 매핑되는 핵심 데이터 모델입니다.

#### 1. `Post.java`

-   **기능 정의**: 게시글의 모든 정보를 담는 핵심 엔티티입니다.
-   **주요 관계 및 필드**:
    -   `@ManyToOne private User user`: `User`와 N:1 양방향 관계. `LAZY` 로딩으로 성능을 최적화.
    -   `@OneToMany private List<Image> images`: `Image`와 1:N 양방향 관계. `cascade = ALL`, `orphanRemoval = true` 옵션을 통해 `Post`의 생명주기에 따라 `Image`가 함께 관리되도록 설정.
    -   `private String location`: **(중요)** "서울시", "부산시" 등 정해진 규격의 지역명이 저장되는 필드.

#### 2. `Image.java`, `User.java`, `BaseEntity.java`

-   **기능 정의**: 각각 이미지 정보, 사용자 정보, 공통 필드(생성/수정 시간)를 담당하는 엔티티입니다.

### Ⅴ. Data Transfer Objects (DTOs)

계층 간 데이터 전송을 담당하며, Entity를 안전하게 보호합니다.

-   **`paging` 패키지**:
    -   `PageRequestDto`: 클라이언트로부터 페이징 및 검색 요청 파라미터를 받는 객체.
    -   `PageResponseDto`: 서버가 클라이언트로 페이징 결과를 전달하는 객체. (페이지네이션 UI 구현에 필요한 모든 정보 포함)
-   **`post` 패키지**:
    -   `PostCreateRequestDto`: 게시글 생성을 위한 데이터를 담는 객체.
    -   `PostUpdateRequestDto`: 게시글 수정을 위한 데이터를 담는 객체.
    -   `PostDetailResponseDto`: 게시글 상세 조회 응답용 객체.
    -   `PostListResponseDto`: 게시글 목록 조회 응답용 객체. **(`thumbnailUrl` 포함)**
    -   `MyPostResponseDto`: '내가 쓴 글' 목록 조회 응답용 객체.
-   **`search` 패키지**:
    -   `CategoryDto`: 동물 카테고리/품종 목록 응답용 객체.
-   **`user` 패키지**:
    -   `AuthorDto`: 게시글 조회 시 작성자 정보를 담는 객체.